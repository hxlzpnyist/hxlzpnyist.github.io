<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content>
    <meta name="author" content="hxlzpnyist">
    <meta name="keywords" content>
    <title>声网sdk体验-直播 ~ 断风雨</title>
    <link rel="stylesheet" href="/css/Material_Icons.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    
        <link rel="stylesheet" href="/css/post.css">
        
            <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
        
    
</head>

<body class=" sidebar-collapse">
<nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">
                断风雨</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/archives/">
                                    归档
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/about/">
                                    关于
                                </a>
                            </li>
                        
                    
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title data-placement="bottom" href="https://github.com/" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-github"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title data-placement="bottom" href="https://twitter.com/" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-twitter"></i>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
    </div>
</nav>
    
  <div class="page-header header-filter" data-parallax="false" style="background-image: url('/img/post-banner.jpg'); height: 70vh;">
    
      <div class="container">
        <h1 class="title text-center post_title">声网sdk体验-直播</h1>
        <p class="text-center"><b>星期日, 四月 14日 2019, 1:46 下午</b></p>
      </div>
    
  </div>

  
  
  
    <div class="row" style="margin: 0 0 0; z-index: 999;">
  <div class="col-md-8 offset-md-1">
    <div class="main main-raised">
      <div class="container">
        <div class="section">
          <div class="post_content">
              <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>直播如何实现的？</p>
<p>下面是基于声网 sdk 快速开发简单直播demo的实现。</p>
<h2 id="功能设计"><a href="#功能设计" class="headerlink" title="功能设计"></a>功能设计</h2><p><img src="https://i.loli.net/2019/06/21/5d0c7de38e26d54660.png" alt></p>
<p>如上图所示为直播 Demo 实现的基本功能展示，包括：</p>
<blockquote>
<p>主播端：</p>
</blockquote>
<ul>
<li>创建直播间</li>
<li>发布、取消发布视频</li>
<li>下播</li>
<li>浏览发送弹幕</li>
</ul>
<blockquote>
<p>访客端：</p>
</blockquote>
<ul>
<li>浏览直播间</li>
<li>观看直播</li>
<li>退出直播间</li>
<li>浏览发送弹幕</li>
</ul>
<p>下面看下本次实现的简易架构图：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/14/16a1bcd4633877f5?w=499&amp;h=325&amp;f=png&amp;s=14223" alt="直播架构"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>在实现之前我们需要创建 Agora 账号并获取 App ID（参见声网的开发者中心）。</p>
<h3 id="主播端"><a href="#主播端" class="headerlink" title="主播端"></a>主播端</h3><h5 id="创建直播间"><a href="#创建直播间" class="headerlink" title="创建直播间"></a>创建直播间</h5><blockquote>
<p>本次实现对于直播间的创建只是简单记录下直播间的名称</p>
</blockquote>
<h6 id="存储直播间名称"><a href="#存储直播间名称" class="headerlink" title="存储直播间名称"></a>存储直播间名称</h6><pre><code class="java">protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // 获取直播间名称
        String room = req.getParameter(&quot;room&quot;);
        // 新增直播间
        RoomListHolder.addRoom(room);

        resp.setCharacterEncoding(&quot;UTF-8&quot;);
        resp.setContentType(&quot;application/json&quot;);

        resp.getWriter().write(&quot;true&quot;);
    }
</code></pre>
<h6 id="Agora-SDK-集成"><a href="#Agora-SDK-集成" class="headerlink" title="Agora SDK 集成"></a>Agora SDK 集成</h6><pre><code class="javascript">    // 创建 Agora Client
    var client = AgoraRTC.createClient({mode: &#39;interop&#39;});
    // 初始化 client，并在初始化成功后执行加入直播间频道
    client.init(&#39;APP ID&#39;, function () {
        // 加入直播间频道
        client.join(null, room, null, function (uid) {
            console.log(&quot;用户 &quot; + uid + &quot;创建了直播间 &quot; + room);

            // 执行本地视频发布
        });
    });
</code></pre>
<h5 id="发布视频"><a href="#发布视频" class="headerlink" title="发布视频"></a>发布视频</h5><blockquote>
<p>主播在完成直播间的创建之后，基于 Agora SDK 实现本地视频的发布，这样当有订阅该直播间频道的用户将会获取视频流。</p>
</blockquote>
<h6 id="获取本地音频设备"><a href="#获取本地音频设备" class="headerlink" title="获取本地音频设备"></a>获取本地音频设备</h6><p>在发布视频前，需要获取本地的音频设备，也即是麦克风，摄像头。</p>
<pre><code class="javascript">AgoraRTC.getDevices(function (devices) {
    for (var i = 0; i !== devices.length; ++i) {
        var device = devices[i];

        if (device.kind === &#39;audioinput&#39;) {
            // 获取麦克风设备
            media.audio = device.deviceId;
        } else if (device.kind === &#39;videoinput&#39;) {
            // 获取摄像头设备
            media.video = device.deviceId;
        }
    }
});
</code></pre>
<h6 id="发布视频-1"><a href="#发布视频-1" class="headerlink" title="发布视频"></a>发布视频</h6><pre><code class="javascript">    // 创建本地音视频流
    var localStream = AgoraRTC.createStream({
        streamID: uid, // Agora 分配的 uid
        audio: true,
        cameraId: camera, 
        microphoneId: microphone,
        video: true,
        screen: false
    });
    // 初始化音视频流
    localStream.init(function () {
        // 指定元素 ID 播放音视频流
        localStream.play(&#39;video&#39;);

        // 发布音视频流
        client.publish(localStream, function (err) {
            console.log(&quot;音视频发布失败: &quot; + err);
        });
        // 监听音视频发布事件
        client.on(&#39;stream-published&#39;, function (evt) {
            console.log(&quot;音视频发布成功!&quot;);
        });
    }, function (err) {
        console.log(&quot;&quot;, err);
    });
</code></pre>
<h5 id="下播"><a href="#下播" class="headerlink" title="下播"></a>下播</h5><blockquote>
<p>下播对于 Agora SDK 来说即是离开频道，同时从直播间列表中移除当前直播间。</p>
</blockquote>
<pre><code class="javascript">client.leave(function () {
    // 主播执行时 会触发访客端事件 peer-leave
    // 访客执行时 不会触发
    console.log(&quot;下播成功&quot;);
    // 将 room 从直播间列表中移除
    $.post(&quot;/removeRoom?room=&quot; + room, {}, function(data, textStatus, jqXHR) {
        // do nothing
    }, &#39;json&#39;);
}, function (err) {
    console.log(&quot;下播失败&quot;);
});
</code></pre>
<pre><code class="java">protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    // 获取待移除的直播间
    String room = req.getParameter(&quot;room&quot;);
    // 移除直播间
    RoomListHolder.removeRoom(room);
}
</code></pre>
<h3 id="访客端"><a href="#访客端" class="headerlink" title="访客端"></a>访客端</h3><blockquote>
<p>访客通过浏览直播间列表，选择自己感兴趣的主播观看。</p>
</blockquote>
<h5 id="浏览直播间"><a href="#浏览直播间" class="headerlink" title="浏览直播间"></a>浏览直播间</h5><pre><code class="javascript">// 获取直播间列表数据
$.get(&quot;/getRooms&quot;, function (data, status) {
    var roomHtml = &#39;&#39;;

    if (data == null) {
        roomHtml = &#39;当前没有直播间&#39;;
    } else {
        $.each(data, function (i, room) {
            roomHtml += &#39;&lt;div class=&quot;layui-col-md6&quot;&gt;\n&#39; +
                &#39;            &lt;div class=&quot;layui-card&quot;&gt;\n&#39; +
                &#39;                &lt;div class=&quot;layui-card-header&quot;&gt;&#39;+ room +&#39;&lt;/div&gt;\n&#39; +
                &#39;                &lt;div class=&quot;layui-card-body&quot;&gt;\n&#39; +
                &#39;                    &lt;button channel=&quot;&#39;+ room +&#39;&quot; class=&quot;layui-btn layui-btn-radius layui-btn-warm view&quot;&gt;\n&#39; +
                &#39;                        &lt;i class=&quot;layui-icon&quot;&gt;&amp;#xe652;&lt;/i&gt; 观看\n&#39; +
                &#39;                    &lt;/button&gt;\n&#39; +
                &#39;                &lt;/div&gt;\n&#39; +
                &#39;            &lt;/div&gt;\n&#39; +
                &#39;        &lt;/div&gt;\n&#39; +
                &#39;        &#39;;
        });
    }
    // 渲染
    $(&#39;#roomList&#39;).html(roomHtml);
});
</code></pre>
<h5 id="观看直播"><a href="#观看直播" class="headerlink" title="观看直播"></a>观看直播</h5><blockquote>
<p>访客观看直播，对于 Agora SDK 来说也就是加入直播间频道，并订阅频道视频流。</p>
</blockquote>
<pre><code class="javascript">client.join(null, room, null, function (uid) {
    console.log(&quot;用户 &quot; + uid + &quot; 来到直播间 &quot; + room);
}, function (err) {
    console.log(&quot;加入直播间失败&quot;)
});

client.on(&#39;stream-added&#39;, function (evt) {
    // 主播发布视频时会触发 stream-added 事件
    var stream = evt.stream;
    // 访客订阅 stream 流
    client.subscribe(stream, function (err) {
        console.log(&quot;视频流订阅失败&quot;, err);
    });
});

client.on(&#39;stream-subscribed&#39;, function (evt) {
    // 主播端视频流订阅成功后触发 stram-subscribed 事件
    var stream = evt.stream;
    // 按指定元素 ID 播放视频流
    stream.play(&#39;video_remote&#39;);
});


client.on(&#39;stream-removed&#39;, function (evt) {
    // 主播端执行 unpublish 时会触发该事件
    var stream = evt.stream;
    // 停止视频播放
    stream.stop();
});

client.on(&#39;peer-leave&#39;, function (evt) {
    // 主播端执行 leave 下播操作时会触发该事件
    var stream = evt.stream;
    if (stream) {
        // 停止视频流播放
        stream.stop();
    }
});
</code></pre>
<h3 id="弹幕"><a href="#弹幕" class="headerlink" title="弹幕"></a>弹幕</h3><p>本次只是对直播的简单实现，弹幕的功能暂时忽略吧，o(╯□╰)o</p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><strong><a href="https://juejin.im/post/5ca1fa9ff265da30b6219179" target="_blank" rel="noopener">Agora SDK 使用体验征文大赛 | 掘金技术征文，征文活动正在进行中</a></strong></p>

          </div>
          <br><br>
          <div>
              <p>
                      
              </p>
          </div>
        </div>
      </div>  
    </div>
  </div>
  <!-- TOC -->
  
  <div id="toc">
    <p class="toc-title"><i class="material-icons" style="vertical-align:middle">toc</i>Toc:</p> 
    <div id="tocbot"></div>
  </div>

</div>


<br>
<!-- Comments -->
<div class="comments" id="comments">

    
    
<div id="vcomments" style="width: 80%;margin: 0 auto;"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
   var notify = 'false' == true ? true : false;
   var verify = 'false' == true ? true : false;
    window.onload = function() {
        new Valine({
            el: '#vcomments',
            notify: notify,
            verify: verify,
            app_id: "eMGsR0oYyKCWntUWOvPI30ul-gzGzoHsz",
            app_key: "Foweb4btd057FvDg9X3M3r83",
            placeholder: "说点什么",
            avatar:"retro",
            meta: ['nick','mail','link'],
            pageSize: "10",
            visitor: "false"
        });
    };
</script>
<noscript>Please enable JavaScript to view the <a href="https://valine.js.org">comments powered by Valine.</a></noscript>


</div>
  

<footer class="footer footer-default">
        <div class="container">
          <div class="float-left" style="padding: 15px 0;">
              <b>多喝热水</b>
          </div>
          <div class="copyright float-right">
            &copy;
            <script>
              document.write(new Date().getFullYear())
            </script>&nbsp;<a href="https://hexo.io/zh-cn/" target="_blank">HEXO</a>&nbsp;<i class="material-icons">favorite_border</i>
            <a href="https://github.com/invom/Material-T" target="_blank">Material-T</a>
          </div>
        </div>
</footer>
      <!--   Core JS Files   -->
      <script src="/js/core/jquery.min.js?v=3.2.1"></script>
      <script src="/js/main.js"></script>
      <script src="/js/core/popper.min.js"></script>
      <script src="/js/core/bootstrap-material-design.min.js"></script>
      <script src="/js/plugins/moment.min.js"></script>
      <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
      <script src="/js/material-kit.min.js?v=2.0.5"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
        <script src="/js/post.js"></script>
        <script src="/js/plugins/prettify.js"></script>
        <script>
            $(document).ready(function(){
                $('pre').addClass('prettyprint linenums');
                prettyPrint();
            })
        </script>
      
</body>
</html>